<html>
<head>
    <meta charset="utf-8">
    <style>
        body {
            text-align: right;
            direction: rtl;
        }
    </style>
    <script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
    <script src="./html2pdf.bundle.min.js"></script>
</head>
<body>
<h1>בה״ד 1 - וידו״צ!</h1>
<ul>
    <h3>צוות 13</h3>
    <div id="t13">
    </div>
    <h3>צוות 14</h3>
    <div id="t14">
    </div>
    <h3>צוות 15</h3>
    <div id="t15">
    </div>
    <h3>צוות 16</h3>
    <div id="t16">
    </div>
    <div>
        <button onclick="createMatzal()">צור מצ״ל!</button>
    </div>
</ul>
<div id="matzal" hidden></div>
</body>
<script>
    const team13 = ['שי ברדה', 'עמית כהן', 'עינב אלבין', 'ספיר כהן', 'ניצן נחמיה', 'נטע קסה', 'נטלי רובינוב ', 'נועה מאיר', 'ינאי אלטר', 'טל בייטר', 'חאלד מלחם', 'דניאל גלסברג', 'אנה זוברב', 'איילה לביא ', 'אור גלוון '];
    const team14 = ['שחר אחרק', 'רותם יונג', 'עידן קליגר', 'עידו וינשטוק', 'סופיה כהן', 'נועה פוקס', 'מיקה יונסי', 'ליאור בן שבת', 'יובל גת', 'זיו יצחק', 'זיו חליוה', 'הילה ריבלוב', 'הדר קוטיק', 'אייל מלמוד'];
    const team15 = ['שירה בנשלום', 'רזי קדור', 'רוני סבן', 'עמרי בר און', 'עמית מאיר', 'עמיר בדרייה', 'עופר חונן', 'ניר בוטבול', 'נטע פרקש', 'נועם לטינסקי', 'מור מצא', 'ליהי פסטרנק', 'יעד כהן', 'יובל סרברניק', 'הלל רוטנברג'];
    const team16 = ['תהילה סרוסי', 'רועי כסלו', 'ענב עסור', 'נדב קורדובה', 'נגה דגן', 'מלי רטה', 'מאי פרום', 'כליל בנו', 'יונתן גרבר', 'יובל בן שלמה', 'ורד אדיס', 'הילה הקימיאן', 'גלי ים', 'אופיר ואקנין', 'אביב גואטה'];

    for (const pair of [['t13', team13], ['t14', team14], ['t15', team15], ['t16', team16]]) {
        const id = pair[0];
        const arr = pair[1];
        for (const [i, name] of arr.entries()) {
            const d = document.createElement('div');
            const checkbox = document.createElement('input');
            const label = document.createElement('label');
            const c_id = `checkbox_${id}_${i}`;
            const d_id = `div_${id}_${i}`;
            checkbox.setAttribute('type', 'checkbox');
            checkbox.setAttribute('checked', '');
            checkbox.setAttribute('onchange', 'toggleInputs(this)');
            checkbox.setAttribute('id', c_id);
            d.setAttribute('id', d_id);
            label.setAttribute('for', c_id);
            label.innerText = name;
            d.appendChild(checkbox);
            d.appendChild(label);
            d.appendChild(generateReasoningDiv(`div_reasoning_${id}_${i}`));
            document.getElementById(id).appendChild(d);
        }
    }

    function generateReasoningDiv(id) {
        const d = document.createElement('div');
        const radioIsolated = document.createElement('input');
        const radioOther = document.createElement('input');
        const radioIsolatedLabel = document.createElement('label');
        const radioOtherInput = document.createElement('input');
        const r_id = `${id}_radioIsolated`;
        radioIsolated.setAttribute('type', 'radio');
        radioIsolated.setAttribute('id', r_id);
        radioIsolated.setAttribute('name', `${id}_absence`);
        radioOther.setAttribute('type', 'radio');
        radioOther.setAttribute('name', `${id}_absence`);
        d.setAttribute('id', id);
        radioIsolatedLabel.setAttribute('for', r_id);
        radioIsolatedLabel.innerText = 'בידוד';
        radioOtherInput.setAttribute('placeholder', 'מבריז כי...');
        radioOtherInput.setAttribute('id', `${id}_input`)
        d.appendChild(document.createElement('br'));
        d.appendChild(radioIsolated);
        d.appendChild(radioIsolatedLabel);
        d.appendChild(document.createElement('br'));
        d.appendChild(radioOther);
        d.appendChild(radioOtherInput);
        d.setAttribute('hidden', '');
        d.setAttribute('style', 'margin-right: 20px; margin-top: -20px;')

        return d;
    }

    function toggleInputs(checkboxEl) {
        const parent = checkboxEl.parentElement;
        const d = parent.children[2];
        if (checkboxEl.checked) {
            d.setAttribute('hidden', '');
        } else {
            d.removeAttribute('hidden');
        }
    }

    function getStatus() {
        const uncheckedDivs = Array.from(
            document.querySelectorAll('input[type="checkbox"]')
        ).filter(checkbox => !checkbox.checked).map(c => c.parentElement);
        const namesAndReasons = uncheckedDivs.map(c => {
            let r = '';
            console.log(c);
            if (c.children[2].children[1].checked) {
                r = 'בידוד/הרחקה';
            } else {
                r = c.children[2].children[5].value;
            }
            return {
                'name': c.children[1].innerText,
                'reason': r
            }
        });

        return namesAndReasons;
    }

    // For the time now
    Date.prototype.timeNow = function () {
        return `${this.getHours() < 10 ? "0" : ""}${this.getHours()}:${((this.getMinutes() < 10) ? "0" : "")}${this.getMinutes()}`;
    }

    function createMatzal() {
        const m = document.createElement('div');
        const title = document.createElement('h1');
        const date = document.createElement('p');
        const time = document.createElement('p');
        const d = new Date();
        const today = `${d.getDate()}/${d.getMonth() + 1}/${d.getFullYear()}`;
        const timeString = d.timeNow();
        const totalCount = team13.length + team14.length + team15.length + team16.length;
        const mzl = document.createElement('p');
        const mzn = document.createElement('p');
        const namesAndReasons = getStatus();
        const mznCount = totalCount - namesAndReasons.length;
        const missing = document.createElement('p');
        const missingList = document.createElement('ul');
        title.innerText = 'מצבה פלוגתית';
        date.innerText = `תאריך: ${today}`;
        mzl.innerText = `מצ״ל: ${totalCount}/${totalCount}`;
        mzn.innerText = `מצ״ן: ${mznCount}/${totalCount}`;
        time.innerText = `שעה: ${timeString}`;
        missing.innerText = ':חסרים';
        m.appendChild(title);
        m.appendChild(date);
        m.appendChild(time);
        m.appendChild(mzl);
        m.appendChild(mzn);
        m.appendChild(missing);
        for (const ob of namesAndReasons) {
            const li = document.createElement('li');
            const name = ob['name'];
            const reason = ob['reason'];
            li.innerText = `${name}: ${reason}`;
            missingList.appendChild(li);
        }
        m.appendChild(missingList);
        document.getElementById('matzal').appendChild(m);

        Array.from(m.children).forEach(c => {
            if (c.childElementCount === 0) {
                c.setAttribute('class', 'text')
            } else {
                Array.from(c.children).forEach(l => l.setAttribute('class', 'text'));
            }
        });

        const texts = document.querySelectorAll('.text'); // Fixes Hebrew spacing!!
        texts.forEach(text => {
            text.innerHTML = text.innerText.replace(/\s/g, "\u00a0");
        });

        const w = html2pdf();
        w.from(m).set({margin: 10}).save();
    }
</script>
</html>